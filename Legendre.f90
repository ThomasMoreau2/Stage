module Legendre

    use constantes

    implicit none 

    ! Liste des poids pour les quadratures
    real(kind=PR), dimension(136), parameter :: weight = [ &
    ! n = 1
    2.0000000000000000_PR, &
    ! n = 2
    1.0000000000000000_PR, 1.0000000000000000_PR, &
    ! n = 3
    0.5555555555555556_PR, 0.8888888888888888_PR, 0.5555555555555556_PR, &
    ! n = 4
    0.3478548451374538_PR, 0.6521451548625461_PR, &
    0.6521451548625461_PR, 0.3478548451374538_PR, &
    ! n = 5
    0.2369268850561891_PR, 0.4786286704993665_PR, 0.5688888888888889_PR, &
    0.4786286704993665_PR, 0.2369268850561891_PR, &
    ! n = 6
    0.1713244923791704_PR, 0.3607615730481386_PR, 0.4679139345726910_PR, &
    0.4679139345726910_PR, 0.3607615730481386_PR, 0.1713244923791704_PR, &
    ! n = 7
    0.1294849661688697_PR, 0.2797053914892766_PR, 0.3818300505051189_PR, &
    0.4179591836734694_PR, 0.3818300505051189_PR, 0.2797053914892766_PR, &
    0.1294849661688697_PR, &
    ! n = 8
    0.1012285362903763_PR, 0.2223810344533745_PR, 0.3137066458778873_PR, &
    0.3626837833783620_PR, 0.3626837833783620_PR, 0.3137066458778873_PR, &
    0.2223810344533745_PR, 0.1012285362903763_PR, &
    ! n = 9
    0.0812743883615744_PR, 0.1806481606948574_PR, 0.2606106964029354_PR, &
    0.3123470770400029_PR, 0.3302393550012598_PR, 0.3123470770400029_PR, &
    0.2606106964029354_PR, 0.1806481606948574_PR, 0.0812743883615744_PR, &
    ! n = 10
    0.0666713443086881_PR, 0.1494513491505806_PR, 0.2190863625159820_PR, &
    0.2692667193099963_PR, 0.2955242247147529_PR, 0.2955242247147529_PR, &
    0.2692667193099963_PR, 0.2190863625159820_PR, 0.1494513491505806_PR, &
    0.0666713443086881_PR, &
    ! n = 11
    0.0556685671161737_PR, 0.1255803694649046_PR, 0.1862902109277343_PR, &
    0.2331937645919905_PR, 0.2628045445102467_PR, 0.2729250867779006_PR, &
    0.2628045445102467_PR, 0.2331937645919905_PR, 0.1862902109277343_PR, &
    0.1255803694649046_PR, 0.0556685671161737_PR, &

    ! n = 12
    0.0471753363865118_PR, 0.1069393259953184_PR, 0.1600783285433462_PR, &
    0.2031674267230659_PR, 0.2334925365383548_PR, 0.2491470458134028_PR, &
    0.2491470458134028_PR, 0.2334925365383548_PR, 0.2031674267230659_PR, &
    0.1600783285433462_PR, 0.1069393259953184_PR, 0.0471753363865118_PR, &
    ! n = 13
    0.0404840047653159_PR, 0.0921214998377285_PR, 0.1388735102197872_PR, &
    0.1781459807619457_PR, 0.2078160475368885_PR, 0.2262831802628972_PR, &
    0.2325515532308739_PR, 0.2262831802628972_PR, 0.2078160475368885_PR, &
    0.1781459807619457_PR, 0.1388735102197872_PR, 0.0921214998377285_PR, &
    0.0404840047653159_PR, &
    ! n = 14
    0.0351194603317519_PR, 0.0801580871597602_PR, 0.1215185706879032_PR, &
    0.1572031671581935_PR, 0.1855383974779378_PR, 0.2051984637212956_PR, &
    0.2152638534631578_PR, 0.2152638534631578_PR, 0.2051984637212956_PR, &
    0.1855383974779378_PR, 0.1572031671581935_PR, 0.1215185706879032_PR, &
    0.0801580871597602_PR, 0.0351194603317519_PR, &
    ! n = 15
    0.0307532419961173_PR, 0.0703660474881081_PR, 0.1071592204671719_PR, &
    0.1395706779261543_PR, 0.1662692058169939_PR, 0.1861610000155622_PR, &
    0.1984314853271116_PR, 0.2025782419255613_PR, 0.1984314853271116_PR, &
    0.1861610000155622_PR, 0.1662692058169939_PR, 0.1395706779261543_PR, &
    0.1071592204671719_PR, 0.0703660474881081_PR, 0.0307532419961173_PR, & 
    ! n = 16
    0.0271524594117541_PR, 0.0622535239386479_PR, 0.0951585116824928_PR, &
    0.1246289712555339_PR, 0.1495959888165767_PR, 0.1691565193950025_PR, &
    0.1826034150449236_PR, 0.1894506104550685_PR, 0.1894506104550685_PR, &
    0.1826034150449236_PR, 0.1691565193950025_PR, 0.1495959888165767_PR, &
    0.1246289712555339_PR, 0.0951585116824928_PR, 0.0622535239386479_PR, &
    0.0271524594117541_PR ]


    ! Liste des abcisses pour les quadratures
    real(kind=PR), dimension(136), parameter :: points = [ &
    ! n = 1
     0.0000000000000000_PR, &
    ! n = 2
    -0.5773502691896257_PR,  0.5773502691896257_PR, &
    ! n = 3
    -0.7745966692414834_PR,  0.0000000000000000_PR,  0.7745966692414834_PR, &
    ! n = 4
    -0.8611363115940526_PR, -0.3399810435848563_PR,  0.3399810435848563_PR, &
     0.8611363115940526_PR, &
    ! n = 5
    -0.9061798459386640_PR, -0.5384693101056831_PR,  0.0000000000000000_PR, &
     0.5384693101056831_PR,  0.9061798459386640_PR, &
    ! n = 6
    -0.9324695142031521_PR, -0.6612093864662645_PR, -0.2386191860831969_PR, &
     0.2386191860831969_PR,  0.6612093864662645_PR,  0.9324695142031521_PR, &
    ! n = 7
    -0.9491079123427585_PR, -0.7415311855993945_PR, -0.4058451513773972_PR, &
     0.0000000000000000_PR,  0.4058451513773972_PR,  0.7415311855993945_PR, &
     0.9491079123427585_PR, &
    ! n = 8
    -0.9602898564975363_PR, -0.7966664774136267_PR, -0.5255324099163290_PR, &
    -0.1834346424956498_PR,  0.1834346424956498_PR,  0.5255324099163290_PR, &
     0.7966664774136267_PR,  0.9602898564975363_PR, &
    ! n = 9
    -0.9681602395076261_PR, -0.8360311073266358_PR, -0.6133714327005904_PR, &
    -0.3242534234038089_PR, -0.0000000000000000_PR,  0.3242534234038089_PR, &
     0.6133714327005904_PR,  0.8360311073266358_PR,  0.9681602395076261_PR, &
    ! n = 10
    -0.9739065285171717_PR, -0.8650633666889845_PR, -0.6794095682990244_PR, &
    -0.4333953941292472_PR, -0.1488743389816312_PR,  0.1488743389816312_PR, &
     0.4333953941292472_PR,  0.6794095682990244_PR,  0.8650633666889845_PR, &
     0.9739065285171717_PR, &
    ! n = 11
    -0.9782286581460570_PR, -0.8870625997680953_PR, -0.7301520055740494_PR, &
    -0.5190961292068118_PR, -0.2695431559523449_PR,  0.0000000000000000_PR, &
     0.2695431559523449_PR,  0.5190961292068118_PR,  0.7301520055740494_PR, &
     0.8870625997680953_PR,  0.9782286581460570_PR, &
    ! n = 12
    -0.9815606342467192_PR, -0.9041172563704749_PR, -0.7699026741943047_PR, &
    -0.5873179542866175_PR, -0.3678314989981802_PR, -0.1252334085114689_PR, &
     0.1252334085114689_PR,  0.3678314989981802_PR,  0.5873179542866175_PR, &
     0.7699026741943047_PR,  0.9041172563704749_PR,  0.9815606342467192_PR, &
    ! n = 13
    -0.9841830547185881_PR, -0.9175983992229779_PR, -0.8015780907333099_PR, &
    -0.6423493394403402_PR, -0.4484927510364469_PR, -0.2304583159551348_PR, &
     0.0000000000000000_PR,  0.2304583159551348_PR,  0.4484927510364469_PR, &
     0.6423493394403402_PR,  0.8015780907333099_PR,  0.9175983992229779_PR, &
     0.9841830547185881_PR, &
    ! n = 14
    -0.9862838086968123_PR, -0.9284348836635735_PR, -0.8272013150697650_PR, &
    -0.6872929048116855_PR, -0.5152486363581541_PR, -0.3191123689278897_PR, &
    -0.1080549487073437_PR,  0.1080549487073437_PR,  0.3191123689278897_PR, &
     0.5152486363581541_PR,  0.6872929048116855_PR,  0.8272013150697650_PR, &
     0.9284348836635735_PR,  0.9862838086968123_PR, &
    ! n = 15
    -0.9879925180204854_PR, -0.9372733924007060_PR, -0.8482065834104272_PR, &
    -0.7244177313601701_PR, -0.5709721726085388_PR, -0.3941513470775634_PR, &
    -0.2011940939974345_PR,  0.0000000000000000_PR,  0.2011940939974345_PR, &
     0.3941513470775634_PR,  0.5709721726085388_PR,  0.7244177313601701_PR, &
     0.8482065834104272_PR,  0.9372733924007060_PR,  0.9879925180204854_PR, &
    ! n = 16
    -0.9894009349916499_PR, -0.9445750230732326_PR, -0.8656312023878318_PR, &
    -0.7554044083550030_PR, -0.6178762444026438_PR, -0.4580167776572274_PR, &
    -0.2816035507792589_PR, -0.0950125098376374_PR,  0.0950125098376374_PR, &
     0.2816035507792589_PR,  0.4580167776572274_PR,  0.6178762444026438_PR, &
     0.7554044083550030_PR,  0.8656312023878318_PR,  0.9445750230732326_PR, &
     0.9894009349916499_PR]


    contains 

    ! Fonction renvoyant la valeur du polynome de Legendre de degre (i-1) a l'abcisse x 
    function Leg(i, x) result(res)

        integer, intent(in) :: i
        real(kind=PR), intent(in) :: x
        real(kind=PR) :: res

        select case(i)
        case(2)
            res = x
        case(3)
            res = 0.5_PR * (3.0_PR * x**2 - 1.0_PR)
        case(4)
            res = 0.5_PR * (5.0_PR * x**3 - 3.0_PR * x)
        case(5)
            res = (1.0_PR / 8.0_PR) * (35.0_PR * x**4 - 30.0_PR * x**2 + 3.0_PR)
        case(6)
            res = (1.0_PR / 8.0_PR) * (63.0_PR * x**5 - 70.0_PR * x**3 + 15.0_PR * x)
        case(7)
            res = (1.0_PR / 16.0_PR) * (231.0_PR * x**6 - 315.0_PR * x**4 + 105.0_PR * x**2 - 5.0_PR)
        case(8)
            res = (1.0_PR / 16.0_PR) * (429.0_PR * x**7 - 693.0_PR * x**5 + 315.0_PR * x**3 - 35.0_PR * x)
        case(9)
            res = (1.0_PR / 128.0_PR) * (6435.0_PR * x**8 - 12012.0_PR * x**6 + 6930.0_PR * x**4 - 1260.0_PR * x**2 + 35.0_PR)
        case(10)
            res = (1.0_PR / 128.0_PR) * (12155.0_PR * x**9 - 25740.0_PR * x**7 + 18018.0_PR * x**5 - &   
                                            4620.0_PR * x**3 + 315.0_PR * x)
        case default
            res = 1.0_PR
        end select
    end function


    ! Norme d'un polynome de Legendre de degre i-1
    function norme(i) result(res)

        integer, intent(in) :: i 
        real(kind=PR) :: res 
        
        res = 2.0_PR/(2.0_PR*(i-1.0_PR)+1.0_PR)

    end function


    ! Fonction prennant une liste de coeffients alpha (coordonnees dans la base de Legendre locale) et renvoie 
    ! la valeur de u aux points (x_1/2, x_3/2, ..., x_imax+1/2)
    function calculate_f(nx, nv, p, alpha) result(f)
         
        integer, intent(in) :: nx, nv, p
        real(kind=PR), dimension(p * nx, 0:nv), intent(in) :: alpha
        real(kind=PR), dimension(0: nx, 0:nv) :: f
        integer :: i, j, l

        f = 0.0_PR

        do l = 0, nv 
            do i = 0, nx - 1
                do j = 1, p 

                    f(i, l) = f(i, l) + alpha(i*p + j, l) * Leg(j, -1.0_PR) ! L'abcisse (i-1)*dx correpsond Ã  evaluer le polynome en -1

                end do 
            end do 

            do j = 1, p 

                f(nx, l) = f(nx, l) + alpha((nx-1)*p + j, l) * Leg(j, 1.0_PR) ! Pour le dernier, il s'agit du polynome en 1

            end do 
        end do 

    end function


    function fact(k) result(res)

        integer, intent(in) :: k 
        real(kind=PR) :: res
        integer :: i

        res = 1.0_PR

        if (k >= 1) then 

            do i = 1, k 

                res = res * i 

            end do 

        end if 

    end function    


end module 